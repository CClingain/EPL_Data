---
title: "Premier League Transfer Data"
author: "Clare Clingain"
date: "August 10, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(dplyr)
library(tidyr)
library(stringr)
```


```{r}
url <- read_html('https://www.transfermarkt.co.uk/premier-league/neuimland/wettbewerb/GB1/saison_id/alle/land_id/alle/ausrichtung//spielerposition_id/alle/altersklasse//w_s//plus/1')
```

```{r}
url %>%
  html_nodes(".page") %>%
  html_text() %>%
  as.numeric()
```
There are two classes we need -- odd and even.

```{r}
oddrows <- read_html(url) %>%
  html_nodes(".odd") %>%
  html_text() 

evenrows <- read_html(url) %>%
  html_nodes(".even") %>%
  html_text()
```

We know there are 21 pages that follow this sort of url: https://www.transfermarkt.co.uk/premier-league/neuimland/wettbewerb/GB1/ajax/yw1/saison_id/alle/land_id/alle/ausrichtung//spielerposition_id/alle/altersklasse//w_s//plus/page/1//page/14

Let's loop through each page to get the data.

```{r}
# Get the URLS
urls <- NULL
for (i in 1:21){
  urls[i] <- paste0('https://www.transfermarkt.co.uk/premier-league/neuimland/wettbewerb/GB1/saison_id/alle/land_id/alle/ausrichtung//spielerposition_id/alle/altersklasse//w_s//plus/page/1//page/',i, sep = "")
  }
```

We will get the odd and even row separately since they are under different nodes.

```{r}
getodddata <- function(url) {
oddrows <- read_html(url) %>% 
  html_nodes(".odd") %>% 
  html_text() %>% 
  gsub('[\r\n\t]', '', .)
}

getevendata <- function(url) {
  evenrows <- read_html(url) %>% 
    html_nodes(".even") %>% 
    html_text() %>% 
    gsub('[\r\n\t]', '', .)
}

myodddata <- lapply(urls,getodddata)
myevendata <- lapply(urls, getevendata)
```

Next, we will combine the data so it'll be easier to parse afterwards as a whole.

```{r}
mydata1 <- do.call(c,myevendata)
mydata2 <- do.call(c,myodddata)
mydata <- as.data.frame(c(mydata1,mydata2), stringsAsFactors = F)
colnames(mydata) <- "player"
```

Now that we have a data frame set up, we can start to declutter the text into meaningful columns of data.

# Data Cleaning

## Extract Position

```{r}
positions <- c("Right Winger","Left-Back","Left Winger", "Centre-Back","Centre-Forward","Attacking Midfield","Right-Back","Defensive Midfield","Central Midfield", "Left Winger", "GoalKeeper","Second Striker","Left Midfield","Right Midfield")

mydata <- mydata %>%
            mutate(RightWinger = str_extract(mydata$player, "Right Winger")) %>%
            mutate(LeftBack = str_extract(mydata$player,"Left-Back")) %>%
            mutate(LeftWinger = str_extract(mydata$player,"LeftWinger")) %>%
            mutate(CentreBack = str_extract(mydata$player,"Centre-Back")) %>%
            mutate(CentreForward = str_extract(mydata$player,"Centre-Forward")) %>%
            mutate(AttackingMidfield = str_extract(mydata$player,"Attacking Midfield")) %>%
            mutate(RightBack = str_extract(mydata$player,"Right-Back")) %>%
            mutate(DefensiveMidfield = str_extract(mydata$player,"Defensive Midfield")) %>%
            mutate(CentralMidfield = str_extract(mydata$player,"Central Midfield")) %>%
            mutate(LeftWinger = str_extract(mydata$player, "Left Winger")) %>%
            mutate(GoalKeeper = str_extract(mydata$player, "Goalkeeper")) %>%
            mutate(SecondStriker = str_extract(mydata$player,"Second Striker")) %>%
            mutate(LeftMidfield = str_extract(mydata$player,"Left Midfield")) %>%
            mutate(RightMidfield = str_extract(mydata$player,"Right Midfield"))
# Combine the position columns
mydata <- mydata %>%
            mutate(position = coalesce(RightWinger, LeftBack,LeftWinger,CentreBack,CentreForward,AttackingMidfield,RightBack,DefensiveMidfield,CentralMidfield, LeftWinger, GoalKeeper, SecondStriker, LeftMidfield, RightMidfield))
# Remove the intermediate columns
mydata2 <- mydata[,c(1,15)]
```

## Extract Season

This is also another element that we can easily get from the text (before we have to do anything a bit whacky).

```{r}
mydata2 <- mydata2 %>% mutate(season = str_extract(mydata2$player,"[0-9][0-9]/[0-9][0-9]"))
# Remove for clarity
mydata2$player <-  str_remove(mydata2$player,"[0-9][0-9]/[0-9][0-9]")
```

## Extract fee + market value

```{r}
 str_extract(mydata2$player,"£[0-9]+[a-z]+") # test
 str_extract(mydata2$player,"£[0-9]+\\.[0-9]+[a-z]+") # market value
 str_extract_all(mydata2$player,"£[0-9]+\\.[0-9]+[a-z]+") # market value and fee

```

